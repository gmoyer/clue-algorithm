<!DOCTYPE html>
<html>
<head>
<script>
//=======================Java====================
const cardNames = [
    "Mustard",
    "Plum",
    "Green",
    "Peacock",
    "Scarlet",
    "White",
    "Knife",
    "Candlestick",
    "Pistol",
    "Rope",
    "Lead Pipe",
    "Wrench",
    "Hall",
    "Lounge",
    "Dining Room",
    "Kitchen",
    "Ball Room",
    "Conservatory",
    "Billiard Room",
    "Library",
    "Study"
];
class Card {
    constructor(index) {
        this.index = index; //int
        this.name = cardNames[index]; //string
        if (index < 6) {
            this.type = 0;
            this.count = 6;
        } else if (index < 12) {
            this.type = 1;
            this.count = 6;
        } else {
            this.type = 2;
            this.count = 9;
        }

        //---master list variables---
        this.odd = 0; //odds of being suspect
        this.odds = []; //odds of being in player's hand
        this.canbe = [];
        this.player = -1; //-1 if unconfirmed, else whoever's hand it belongs to
    }
}

class Player {
    constructor(num, index) {
        this.name = "";
        this.index = index; //the index of the player
        this.hand = []; //cards that the player does have
        this.neghand = []; //cards that the player does not have
        this.handSize = num; //how many cards each player has
        this.emptySpots = num; //number of unconfirmed spots a player has

        this.cardCount = 0; //functionality ONLY for player 0 when selecting cards during setup
    }

    addCard(index, newPush=true) {
        if (newPush) {
            this.hand.push(new Card(index));
        }
        this.emptySpots--;
        cardsLeft[cards[index].type]--;
        cards[index].player = this.index;

        for (var i = 0; i < playerCount; i++) {
            if (i != this.index) {
                cards[index].canbe[i] = 0;
            }
        }
        
        for (var i = 0; i < activeCards.length; i++) {
            if (activeCards[i].index == index) {
                activeCards.splice(i);
                return;
            }
        }
    }

    removeCard(index) {
        this.neghand.push(new Card(index));
        cards[index].canbe[this.index] = 0;
    }
}

var playerCount = 0;
const players = []; //list of all of the players
var playerEmptySpots = 0;

const cards = []; //master list of cards with odds of being the murderer or in player's hand
const cardCount = 21; //all of the cards in the game
const activeCards = []; //all of the unknown cards
const cardsLeft = [6, 6, 9]; //the cards left in each type of card
const cardCombos = [24, 24, 27] //hand slots plus the numbers of ways it can be the active card

for (var i = 0; i < cardCount; i++) {
    cards[i] = new Card(i);
    activeCards[i] = cards[i];
}

//---step 1---:
function adjustPlayers(i) {
    playerCount += i;
    document.getElementById("playerCount").innerHTML = playerCount;
}

//---step 2---:
function setupGame() {
    document.getElementById("openDiv").style.display = "none";

    const setupDiv = document.getElementById("setupDiv");
    setupDiv.style.display = "block";

    for (var i = 0; i < playerCount; i++) {
        players[i] = new Player(Math.floor(18 / playerCount), i);

        const input = document.createElement("input");
        input.id = "playerInput" + i;
        setupDiv.appendChild(input);
        const down = document.createElement("button");
        down.setAttribute("onclick", "adjustCardCount(" + i + ", -1)");
        down.innerHTML = "\\/";
        const up = document.createElement("button");
        up.innerHTML = "/\\";
        up.setAttribute("onclick", "adjustCardCount(" + i + ", 1)");
        const disp = document.createElement("span");
        disp.innerHTML = " " + players[i].handSize + " ";
        disp.id = "playerCardCount" + i;        


        setupDiv.appendChild(down);
        setupDiv.appendChild(disp);
        setupDiv.appendChild(up);

        setupDiv.appendChild(document.createElement("br"));
        setupDiv.appendChild(document.createElement("br"));
    }

    for (var i = 0; i < cardCount; i++) {
        const input = document.createElement("button");
        input.setAttribute("onclick", "selectAsOwn(" + i + ")");
        input.innerHTML = cardNames[i];

        setupDiv.appendChild(input);
        setupDiv.appendChild(document.createElement("br"));
    }
}
function adjustCardCount(i, n) {
    players[i].handSize += n;
    players[i].emptySpots += n;
    document.getElementById("playerCardCount" + i).innerHTML = " " + players[i].handSize + " ";

}
function selectAsOwn(index) {
    var removed = false;
    for (var i = 0; i < players[0].cardCount; i++) {
        if (players[0].hand[i].index == index) {
            players[0].hand.splice(i, 1);
            players[0].cardCount--;
            const selected = document.getElementById("selectedCard" + index);
            selected.parentNode.removeChild(selected);
            removed = true;
        }
    }
    if (!removed) {
        players[0].hand[players[0].cardCount++] = new Card(index);
        players[0].hand[players[0].cardCount-1].odd = 1;
        const selected = document.createElement("div");
        selected.id = "selectedCard" + index;
        selected.innerHTML = cardNames[index];
        document.getElementById("setupDiv").appendChild(selected);
    }

    //add start button if there is enough cards
    if (players[0].cardCount == players[0].handSize) {
        const startButton = document.createElement("button");
        startButton.innerHTML = "Start";
        startButton.id = "startButton";
        startButton.setAttribute("onclick", "startGame()");
        document.getElementById("setupDiv").appendChild(startButton);
    } else {
        const startButton = document.getElementById("startButton");
        if (startButton != null) {
            startButton.parentNode.removeChild(startButton);
        }
    }
}


//---step 3---
function startGame() {
    //update where the cards can be
    cards.forEach(card => {
        for (var i = 0; i < playerCount; i++) {
            card.canbe[i] = 1;
        }
    });

    //update status of player's chosen cards
    players[0].hand.forEach(card => {
        players[0].addCard(card.index, false);
    }); 

    players[1].removeCard(5);

    players[2].addCard(9);

    recalculateOdds();

    printOdds();
}



function recalculateOdds() {
    //use all the information given to calculate the odds in the master card table
    cards.forEach(card => {
        if (card.player == -1) { //unconfirmed card
            //the chance of being the suspect
            card.odd = 1 / cardsLeft[card.type];

            //find the number of places the card can exist
            var masterslots = 0;
            var neghand = 0;
            for (var i = 0; i < playerCount; i++) {
                masterslots += card.canbe[i]*players[i].emptySpots;
                neghand += players[i].neghand.length;
            }

            for (var i = 0; i < playerCount; i++) {
               
                //each card a player confirmed does not have must take up a slot outside of the player's hand
                var slots = masterslots-players[i].neghand.length;
                var unaccountedNeg = neghand-players[i].neghand.length;

                //the odds are the spots in a player's hand divided by the total slots
                //AND (times)
                //the odds of it not being the suspect card
                //multiply by whether it can be in the player's hand (a value of 0 or 1, like a true false)
                card.odds[i] = (players[i].emptySpots / slots);

                card.odds[i] -= (unaccountedNeg*players[i].emptySpots)/(slots * (slots - unaccountedNeg));
                card.odds[i] *= card.canbe[i];
                card.odds[i] *= 1-card.odd;
            }
        } else { //confirmed card
            for (var i = 0; i < playerCount; i++) {
                if (i == card.player) {
                    card.odds[i] = 1;
                } else {
                    card.odds[i] = 0;
                }
            }
        }
    });
}




function printOdds() {
    var totals = [];
    for (var i = 0; i < playerCount; i++) {
        totals[i] = 0;
    }
    const output = document.createElement("div");
    cards.forEach(card => {
        output.innerHTML += card.name + ": ";
        for (var i = 0; i < playerCount; i++) {
            output.innerHTML += (card.odds[i]) + ", ";
            totals[i] += card.odds[i];
        }
        output.innerHTML += "|" + card.odd;
        output.innerHTML += "<br>";
    });
    output.innerHTML += "Totals: ";
    for (var i = 0; i < totals.length; i++) {
        output.innerHTML += totals[i] + ", ";
    }
    document.getElementById("setupDiv").appendChild(output);
}

</script>
</head>
<body>
<!-- ===================HTML====================== -->
<div id="openDiv">
    <button onClick="adjustPlayers(1)">/\</button>
    <div id="playerCount">0</div>
    <button onClick="adjustPlayers(-1)">\/</button>
    <button onclick="setupGame()">Start</button>
</div>

<div id="setupDiv" style="display: none">
    <div>You:</div>
</div>

</body>
</html>