<!DOCTYPE html>
<html>
<head>
<script>
//=======================Java====================
const cardNames = [
    "Mustard",
    "Plum",
    "Green",
    "Peacock",
    "Scarlet",
    "White",
    "Knife",
    "Candlestick",
    "Pistol",
    "Rope",
    "Lead Pipe",
    "Wrench",
    "Hall",
    "Lounge",
    "Dining Room",
    "Kitchen",
    "Ball Room",
    "Conservatory",
    "Billiard Room",
    "Library",
    "Study"
];
class Card {
    constructor(index) {
        this.index = index; //int
        this.name = cardNames[index]; //string

        if (index < 6) {
            this.type = 0; //person
            this.count = 6;
        } else if (index < 12) {
            this.type = 1; //weapon
            this.count = 6;
        } else {
            this.type = 2; //room
            this.count = 9;
        }
        this.odds = [0, 0, 0]; //odds of it existing in index spot (0: suspect person, 1: suspect weapon, 2: suspect room)
    }
}

class Player {
    constructor(num) {
        this.name = "";
        this.hand = []; //functionality for player 0 ONLY during setup
        this.handSize = num; //how many cards each player has
        this.cardCount = 0; //functionality ONLY for player 0 when selecting cards during setup

        this.startIndex = 0;
    }
}

var playerCount = 0;
const players = []; //list of all of the players

const cards = []; //master list of cards with odds of being the murderer
const cardsLength = 21; //all of the cards in the game
const activeCards = 18;

for (var i = 0; i < cardsLength; i++) {
    cards[i] = new Card(i);
}

//-----------------step 1--------------:
function adjustPlayers(i) {
    playerCount += i;
    document.getElementById("playerCount").innerHTML = playerCount;
}

// ---------------------step 2------------------------:
function setupGame() {
    document.getElementById("openDiv").style.display = "none";

    const setupDiv = document.getElementById("setupDiv");
    setupDiv.style.display = "block";

    for (var i = 0; i < playerCount; i++) {
        players[i] = new Player(Math.floor(18 / playerCount));

        const input = document.createElement("input");
        input.id = "playerInput" + i;
        setupDiv.appendChild(input);
        const down = document.createElement("button");
        down.setAttribute("onclick", "adjustCardCount(" + i + ", -1)");
        down.innerHTML = "\\/";
        const up = document.createElement("button");
        up.innerHTML = "/\\";
        up.setAttribute("onclick", "adjustCardCount(" + i + ", 1)");
        const disp = document.createElement("span");
        disp.innerHTML = " " + players[i].handSize + " ";
        disp.id = "playerCardCount" + i;        


        setupDiv.appendChild(down);
        setupDiv.appendChild(disp);
        setupDiv.appendChild(up);

        setupDiv.appendChild(document.createElement("br"));
        setupDiv.appendChild(document.createElement("br"));
    }

    for (var i = 0; i < cardsLength; i++) {
        const input = document.createElement("button");
        input.setAttribute("onclick", "selectAsOwn(" + i + ")");
        input.innerHTML = cardNames[i];

        setupDiv.appendChild(input);
        setupDiv.appendChild(document.createElement("br"));
    }
}
function adjustCardCount(i, n) {
    players[i].handSize += n;
    players[i].oddHandSize += n;
    document.getElementById("playerCardCount" + i).innerHTML = " " + players[i].handSize + " ";

}
function selectAsOwn(index) {
    var removed = false;
    for (var i = 0; i < players[0].cardCount; i++) {
        if (players[0].hand[i].index == index) {
            players[0].hand.splice(i, 1);
            players[0].cardCount--;
            const selected = document.getElementById("selectedCard" + index);
            selected.parentNode.removeChild(selected);
            removed = true;
        }
    }
    if (!removed) {
        players[0].hand[players[0].cardCount++] = new Card(index);
        players[0].hand[players[0].cardCount-1].odd = 1;
        const selected = document.createElement("div");
        selected.id = "selectedCard" + index;
        selected.innerHTML = cardNames[index];
        document.getElementById("setupDiv").appendChild(selected);
    }

    //add start button if there is enough cards
    if (players[0].cardCount == players[0].handSize) {
        const startButton = document.createElement("button");
        startButton.innerHTML = "Start";
        startButton.id = "startButton";
        startButton.setAttribute("onclick", "startGame()");
        document.getElementById("setupDiv").appendChild(startButton);
    } else {
        const startButton = document.getElementById("startButton");
        if (startButton != null) {
            startButton.parentNode.removeChild(startButton);
        }
    }
}


//---------------main functionality----------------------------
function startGame() {
    //set player start indicies
    var i = 3;
    for (var l = 0; l < playerCount; l++) {
        players[l].startIndex = i;
        i += players[l].handSize;
        console.log(players[l].startIndex);
    }

    //set base odds
    cards.forEach(card => {
        //set suspect odd
        card.odds[card.type] = 1/card.count;
        players.forEach(player => {
            for (var i = 0; i < player.handSize; i++) {
                //the odds of it not being the chosen card and it being in that spot
                card.odds.push((1-card.odds[card.type])*(1/activeCards));
            }
        });
    });


    printOdds();
    setPlayerOdd(0, 0);
    printOdds();
    return;
    //set the player's hand
    players[0].hand.forEach(card => {
        setPlayerOdd(card.index, 0);
    });

    //moves.push(new Move(0, 1, [6, 9, 10]));

    printOdds();
    return;
    //newMove(0, 1, [20, 19, 18, 17, 16, 15, 14, 11]);
    newMove(1, 1, [18, 17, 16, 15, 14, 13]);

    printOdds();
}


//general rule for when new information is found:
//when a probability is changed from x to y, let another probability (p) dependent on that probability equal ((1-y)*p)/(1-x)

function newMove(moveType, player, involvedCards) {
    if (moveType == 0) { //pass
        //handle each of the involved cards
        for (var i = 0; i < involvedCards.length; i++) {
            adjustOdd(involvedCards[i], player, false);
        }
    }
    if (moveType == 1) { //showing a card
        //handle each of the involved cards
        for (var i = 0; i < involvedCards.length; i++) {
            adjustOdd(involvedCards[i], player, true);
        }
    }
}

function oddMath(a, o, n) {//a = card to adjust, o = old odd, n = new odd
    if (1-o == 0) {
        console.log("cannot adjust");
        return a;
    }
    return ((1-n)*a)/(1-o);
}

function setPlayerOdd(index, player) {
    for (var i = 0; i < playerCount; i++) {
        if (i != player) {
            removePlayerOdd(index, i);
        }
    }
    removeOdd(index, cards[index].type);
}

function removePlayerOdd(index, player) {
    for (var i = 0; i < players[player].handSize; i++) {
        removeOdd(index, players[player].startIndex+i);
    }
    //setOdd(index, cards[index].type, 0);
}

function removeOdd(index, spot) {
    const card = cards[index];

    //Record the before and after
    var oldMasterOdd = card.odds[spot];
    card.odds[spot] = 0;
    var newMasterOdd = 0;

    //adjust card row
    for (var i = 0; i < card.odds.length; i++) {
        card.odds[i] = oddMath(card.odds[i], oldMasterOdd, newMasterOdd);
    }

    //adjust every other card
    cards.forEach(card2 => {
        for (var i = 0; i < card2.odds.length; i++) {
            if (card2.index != card.index && i != spot) { //is not in the row or same column as changed odd
                var oddsOfBoth = oldMasterOdd * oddMath(card2.odds[i], card2.odds[spot], 0);
                card2.odds[i] *= 1-(oddsOfBoth / (1-card2.odds[i]));
            }
        }
    });

    cards.forEach(card2 => {
        for (var i = 0; i < card2.odds.length; i++) {
            if (card2.index != card.index && i == spot) { //is in the same column as changed odd but not same row
                card2.odds[i] = oddMath(card2.odds[i], oldMasterOdd, newMasterOdd);
            }
        }
    });
}

function adjustOdd(index, player, isAdd) {
    const card = cards[index];
    var oldMasterOdd, newMasterOdd, oldSuspectOdd, newSuspectOdd;

    if (isAdd) {

        //set the odds of each other one to zero
        for (var i = 0; i < playerCount; i++) {
            if (i != player) {
                adjustOdd(index, i, false);
            }
        }

        //remove the odds of it being the suspect
        oldSuspectOdd = card.odd;
        card.odd = 0;
        newSuspectOdd = 0;

        //set the odds that the player has it to 1
        oldMasterOdd = card.odds[player];
        card.odds[player] = 1;
        newMasterOdd = 1;
    } else {
        //take the card out of that player's hand, and save the removed odd
        oldMasterOdd = card.odds[player];
        card.odds[player] = 0;
        newMasterOdd = 0;
        //adjust horizontally, changing the odds of where that card can exist (player's hands or chosen)
        for (var l = 0; l < playerCount; l++) {
            card.odds[l] /= 1-oldMasterOdd;
        }
        oldSuspectOdd = card.odd;
        card.odd /= 1-oldMasterOdd;
        newSuspectOdd = card.odd;
    }

    

    //adjust vertically, changing the odds of each other card for that specific player
    //var vertAdjust = (players[player].oddHandSize - removedOdd) / players[player].oddHandSize;

    //i thought i should do this but didn't have to
    //players[player].oddHandSize -= removedOdd;

    for (var l = 0; l < cardsLength; l++) {
        if (l != card.index) {
            //if (cards[l].type != card.type) { //card that is not in the same group as the chosen card
                var oldOdd = cards[l].odds[player];
                cards[l].odds[player] = ((players[player].handSize-newMasterOdd)*cards[l].odds[player])/(players[player].handSize-oldMasterOdd);
                var newOdd = cards[l].odds[player];

                for (var k = 0; k < playerCount; k++) {
                    if (k != player) {
                        //the math here just works
                        if (1-oldOdd-cards[l].odd != 0) {
                            cards[l].odds[k] = ((1-newOdd-cards[l].odd)*cards[l].odds[k])/(1-oldOdd-cards[l].odd);
                        }
                    }
                }
            if (cards[l].type == card.type) {//} else { //card that is in the same group as the chosen card
                //the chance of it being the chosen card decreases, and the chance of it being other places increases
                //so esencially, the same as above, but including the odd of it being the chosen card when readjusting
                var oldOdd = cards[l].odd;
                cards[l].odd = ((1-newSuspectOdd)*cards[l].odd)/(1-oldSuspectOdd);
                var newOdd = cards[l].odd;

                for (var k = 0; k < playerCount; k++) {
                    //the math here just works
                    if (1-oldOdd != 0) {
                        cards[l].odds[k] = ((1-newOdd)*cards[l].odds[k])/(1-oldOdd);
                    }
                }
            }
        }
    }
}

function printOdds() {
    var totals = [];
    for (var i = 0; i < cardsLength; i++) {
        totals[i] = 0;
    }
    const output = document.createElement("div");
    cards.forEach(card => {
        output.innerHTML += card.name + ": ";
        for (var i = 0; i < card.odds.length; i++) {
            output.innerHTML += (Math.round(card.odds[i]*1000)/1000) + ", ";
            totals[i] += card.odds[i];
        }
        output.innerHTML += "<br>";
    });
    output.innerHTML += "Totals: ";
    for (var i = 0; i < totals.length; i++) {
        output.innerHTML += (Math.round(totals[i]*100)/100) + ", ";
    }
    document.getElementById("setupDiv").appendChild(output);
}

</script>
</head>
<body>
<!-- ===================HTML====================== -->
<div id="openDiv">
    <button onClick="adjustPlayers(1)">/\</button>
    <div id="playerCount">0</div>
    <button onClick="adjustPlayers(-1)">\/</button>
    <button onclick="setupGame()">Start</button>
</div>

<div id="setupDiv" style="display: none">
    <div>You:</div>
</div>

</body>
</html>